
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2225%22 fill=%22%23800020%22/><path d=%22M50 20 L80 50 L50 80 L20 50 Z%22 fill=%22white%22/><path d=%22M50 20 L80 50 L50 50 Z%22 fill=%22%23eeeeee%22/><path d=%22M20 50 L50 80 L50 50 Z%22 fill=%22%23cccccc%22/></svg>">  <title>Analysis</title>
  
  <!-- CDNs: React, Babel, Tailwind, Lucide, Fonts -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            maroon: {
              DEFAULT: '#800020',
              light: '#a52a2a',
              dark: '#500010',
            }
          },
          fontFamily: {
            cairo: ['Cairo', 'sans-serif'],
          },
          borderRadius: {
            '4xl': '2rem',
            '5xl': '2.5rem',
          }
        }
      }
    }
  </script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      scroll-behavior: smooth;
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #800020;
      border-radius: 10px;
    }
    
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-screen {
      animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    /* Custom Toast Animation */
    @keyframes toastFade {
      0% { opacity: 0; transform: translate(-50%, -20px); }
      15% { opacity: 1; transform: translate(-50%, 0); }
      85% { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, -20px); }
    }
    .toast-active {
      animation: toastFade 3s ease-in-out forwards;
    }

    details > summary {
      list-style: none;
    }
    details > summary::-webkit-details-marker {
      display: none;
    }
    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    // --- Constants ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxyMTNwH-cQjWS-5cOmlMBf42F1vBi15tKZDVC8CvjQwwIH6j0e857u7WgWJbnURHWc/exec";
    
    const CATEGORIES = [
      "Ø§Ø³ØªØ´Ø§Ø±Ø© Ø´Ø¹Ø±", "Ø§Ø³ØªØ´Ø§Ø±Ø© Ø¨Ø´Ø±Ø©", "ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø·Ø¨ÙŠØ¨ Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¹ÙŠ",
      "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ÙŠÙ†Ùƒ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¹ÙŠ", "Ø¹Ø¯Ù… Ø´Ø±Ø­ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…",
      "ÙØ±ØµØ© Ø¨ÙŠØ¹ Ø¶Ø§Ø¦Ø¹Ø©", "Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„"
    ];

    const INQUIRY_TYPES = [
      "Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯", "Ù…Ù†ØªØ¬ Ù…ØªÙˆÙØ±", "Ø¹Ø±Ø¶ Ø¨Ø¯ÙŠÙ„", "Ø±ÙˆØ´ØªÙ‡", "Ø§Ø³ØªØ´Ø§Ø±Ø© Ø¨Ø´Ø±Ø©", "Ø§Ø³ØªØ´Ø§Ø±Ø© Ø´Ø¹Ø±", "Ø¹Ø±ÙˆØ¶"
    ];

    const FOLLOWUP_RESULTS = [
      "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø§Ø·Ù„Ø§Ù‚Ø§", "ØªÙ… Ø§Ù„Ø±Ø¯ Ø¨Ø¯ÙˆÙ† Ù†Ù‚Ø§Ø´", "Ù†Ù‚Ø§Ø´ Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø§Ø¡", "Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù†ÙØ° Ø§ÙˆØ±Ø¯Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"
    ];

    const REVIEWERS = ["Ahmed Alaa", "Mariam Kamal"];

    // --- API ---
    const api = {
      async fetchData() {
        const res = await fetch(`${SCRIPT_URL}?action=readAll`);
        return await res.json();
      },
      async postData(action, payload) {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action, ...payload }),
          mode: 'no-cors'
        });
        return { status: 'success' };
      }
    };

    // --- Components ---
    const Toast = ({ message }) => {
      if (!message) return null;
      return (
        <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[200] toast-active bg-maroon text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-2 font-bold border border-white/20">
          <span className="text-lg">âœ¨</span>
          {message}
        </div>
      );
    };

    const ScreenHeader = ({ title, subtitle, icon, totalLabel, totalCount }) => (
      <div className="bg-gradient-to-br from-maroon to-maroon-dark text-white p-5 md:p-6 rounded-3xl shadow-lg relative overflow-hidden flex justify-between items-center mb-6">
        <div className="absolute top-0 right-0 w-24 h-24 bg-white/5 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>
        <div className="z-10 text-right">
          <h2 className="text-lg md:text-xl font-black flex items-center gap-2">
            {icon} {title}
          </h2>
          <p className="text-[10px] md:text-[11px] opacity-70 font-bold tracking-wide">{subtitle}</p>
        </div>
        <div className="text-center z-10 bg-white/10 p-2 md:p-3 rounded-2xl backdrop-blur-md border border-white/5 min-w-[70px]">
          <p className="text-[7px] opacity-80 font-black tracking-widest uppercase mb-0.5">{totalLabel}</p>
          <p className="text-xl font-black">{totalCount}</p>
        </div>
      </div>
    );

    const ReviewScreen = ({ data, onRefresh, showToast }) => {
      const [phone, setPhone] = useState('');
      const [msgDate, setMsgDate] = useState(new Date().toISOString().split('T')[0]);
      const [empSearch, setEmpSearch] = useState('');
      const [selectedEmp, setSelectedEmp] = useState(null);
      const [comment, setComment] = useState('');
      const [reviewer, setReviewer] = useState(REVIEWERS[0]);
      const [selectedCats, setSelectedCats] = useState([]);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [showDropdown, setShowDropdown] = useState(false);
      const dropdownRef = useRef(null);

      useEffect(() => {
        const clickAway = (e) => { if (dropdownRef.current && !dropdownRef.current.contains(e.target)) setShowDropdown(false); };
        document.addEventListener('mousedown', clickAway);
        return () => document.removeEventListener('mousedown', clickAway);
      }, []);

      const filteredEmps = useMemo(() => {
        if (!empSearch) return data.employees;
        return data.employees.filter(e => e.EmployeeName.toLowerCase().includes(empSearch.toLowerCase()));
      }, [empSearch, data.employees]);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!selectedEmp || !phone || selectedCats.length === 0) return alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        setIsSubmitting(true);
        try {
          await api.postData('addReview', {
            messageDate: msgDate,
            customerPhone: phone,
            employeeName: selectedEmp.EmployeeName,
            supervisorName: selectedEmp.SupervisorName,
            comment,
            categories: selectedCats.join(', '),
            reviewerName: reviewer
          });
          showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
          setPhone(''); setComment(''); setSelectedCats([]); setEmpSearch(''); setSelectedEmp(null);
          onRefresh();
        } catch (err) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£"); }
        setIsSubmitting(false);
      };

      return (
        <div className="animate-screen">
          <ScreenHeader title="Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª" subtitle="Ø¬ÙˆØ¯Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø²Ù…Ù„Ø§Ø¡" icon="ğŸ“" totalLabel="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" totalCount={data.reviews.length} />
          <form onSubmit={handleSubmit} className="bg-white p-6 rounded-3xl shadow-sm space-y-6 border border-gray-100">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-1">
                <label className="text-[11px] font-black text-gray-500">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</label>
                <select value={reviewer} onChange={e => setReviewer(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-xl font-bold focus:border-maroon outline-none">
                  {REVIEWERS.map(r => <option key={r} value={r}>{r}</option>)}
                </select>
              </div>
              <div className="space-y-1">
                <label className="text-[11px] font-black text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</label>
                <input type="date" value={msgDate} onChange={e => setMsgDate(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-xl font-bold focus:border-maroon outline-none" required />
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-1">
                <label className="text-[11px] font-black text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                <input type="text" placeholder="01xxxxxxxxx" value={phone} onChange={e => setPhone(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-xl font-bold focus:border-maroon outline-none" required />
              </div>
              <div className="space-y-1 relative" ref={dropdownRef}>
                <label className="text-[11px] font-black text-gray-500">Ø§Ø³Ù… Ø§Ù„Ø²Ù…ÙŠÙ„</label>
                <input type="text" placeholder="Ø§Ø¨Ø­Ø«..." value={selectedEmp ? selectedEmp.EmployeeName : empSearch} onChange={e => { setEmpSearch(e.target.value); setSelectedEmp(null); setShowDropdown(true); }} onFocus={() => setShowDropdown(true)} className="w-full p-3 bg-gray-50 border rounded-xl font-bold focus:border-maroon outline-none" required />
                {showDropdown && filteredEmps.length > 0 && (
                  <ul className="absolute z-50 w-full mt-1 bg-white border rounded-xl shadow-xl max-h-48 overflow-y-auto">
                    {filteredEmps.map((emp, i) => (
                      <li key={i} onClick={() => { setSelectedEmp(emp); setShowDropdown(false); }} className="p-3 hover:bg-maroon hover:text-white cursor-pointer font-bold border-b text-xs">
                        {emp.EmployeeName} <span className="text-[9px] opacity-60 block">Ø§Ù„Ù…Ø´Ø±Ù: {emp.SupervisorName}</span>
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </div>
            <div className="space-y-2">
              <label className="text-[11px] font-black text-gray-500">ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</label>
              <div className="flex flex-wrap gap-2">
                {CATEGORIES.map(cat => (
                  <button key={cat} type="button" onClick={() => setSelectedCats(prev => prev.includes(cat) ? prev.filter(c => c !== cat) : [...prev, cat])} className={`px-3 py-2 rounded-lg text-[10px] font-black transition-all border ${selectedCats.includes(cat) ? 'bg-maroon text-white border-maroon' : 'bg-white text-gray-500 border-gray-100'}`}>
                    {cat}
                  </button>
                ))}
              </div>
            </div>
            <div className="space-y-1">
              <label className="text-[11px] font-black text-gray-500">Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
              <textarea value={comment} onChange={e => setComment(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-xl font-bold focus:border-maroon outline-none h-24 resize-none" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒØ§Ù…Ù„Ø© Ùˆ Ø§Ù„ØªØµØ±Ù Ø§Ù„Ø£Ù…Ø«Ù„..." required />
            </div>
            <button type="submit" disabled={isSubmitting} className="w-full bg-maroon text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-maroon-dark disabled:opacity-50">
              {isSubmitting ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'}
            </button>
          </form>
        </div>
      );
    };

    const FollowUpScreen = ({ data, onRefresh, showToast }) => {
      const [tab, setTab] = useState('pending');
      const [updating, setUpdating] = useState(null);

      const FOLLOWUP_RESULTS = ["Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø§Ø·Ù„Ø§Ù‚Ø§", "ØªÙ… Ø§Ù„Ø±Ø¯ Ø¨Ø¯ÙˆÙ† Ù†Ù‚Ø§Ø´", "Ù†Ù‚Ø§Ø´ Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø§Ø¡", "Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù†ÙØ° Ø§ÙˆØ±Ø¯Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"];

      const { pending, completed } = useMemo(() => {
        const reviews = data.reviews.filter(r => r.Category.includes("Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„"));
        const p = [], c = [];
        reviews.forEach(r => {
          const info = data.followups.find(f => f.CustomerPhone === r.CustomerPhone);
          if (info) c.push({ ...r, followUpInfo: info });
          else p.push(r);
        });
        return { pending: p, completed: c };
      }, [data]);

      const items = tab === 'pending' ? pending : completed;

      const handleUpdate = async (phone, result) => {
        setUpdating(phone);
        try {
          await api.postData('addFollowUp', { customerPhone: phone, followUpResult: result });
          showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­");
          onRefresh();
        } catch (e) { alert("Error"); }
        finally { setUpdating(null); }
      };

      return (
        <div className="animate-in space-y-6">
          <ScreenHeader title="Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©" subtitle="Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØªØ¨Ø¹ ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡" icon="âœ¨" totalLabel="Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¹Ù…Ù„" totalCount={pending.length} />
          
          <div className="flex bg-white p-1.5 rounded-[1.5rem] shadow-sm border border-gray-100">
            <button onClick={() => setTab('pending')} className={`flex-1 py-4 font-black text-xs rounded-2xl transition-all flex items-center justify-center gap-2 ${tab === 'pending' ? 'bg-maroon text-white shadow-lg' : 'text-gray-400 hover:bg-gray-50'}`}>
              <span>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>
              <span className={`px-2 py-0.5 rounded-full text-[10px] ${tab === 'pending' ? 'bg-white/20' : 'bg-gray-100'}`}>{pending.length}</span>
            </button>
            <button onClick={() => setTab('completed')} className={`flex-1 py-4 font-black text-xs rounded-2xl transition-all flex items-center justify-center gap-2 ${tab === 'completed' ? 'bg-maroon text-white shadow-lg' : 'text-gray-400 hover:bg-gray-50'}`}>
              <span>Ù…ÙƒØªÙ…Ù„</span>
              <span className={`px-2 py-0.5 rounded-full text-[10px] ${tab === 'completed' ? 'bg-white/20' : 'bg-gray-100'}`}>{completed.length}</span>
            </button>
          </div>

          <div className="space-y-4">
            {items.length === 0 ? (
              <div className="bg-white p-12 rounded-3xl text-center border border-gray-100 opacity-40">
                <p className="text-3xl mb-1">âœ…</p>
                <p className="text-[11px] font-black uppercase">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ {tab === 'pending' ? 'Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©' : 'ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'}</p>
              </div>
            ) : (
              items.map((item, i) => (
                <div key={i} className={`bg-white p-5 rounded-3xl shadow-sm border-r-[6px] transition-all border border-gray-100 ${tab === 'pending' ? 'border-r-maroon' : 'border-r-green-500'}`}>
                  <div className="flex justify-between items-center mb-4">
                    <p className="text-xl font-black text-gray-800 tracking-wide">{item.CustomerPhone}</p>
                    <button onClick={() => { navigator.clipboard.writeText(item.CustomerPhone); showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…"); }} className="p-2 bg-gray-50 rounded-xl">ğŸ“‹</button>
                  </div>
                  <div className="bg-gray-50/80 p-4 rounded-2xl text-[11px] mb-5 border border-gray-100/50">
                    <div className="flex justify-between items-center mb-2">
                      <span className="font-black text-maroon">Ø§Ù„Ø²Ù…ÙŠÙ„: {item.EmployeeName}</span>
                      <span className="text-[9px] bg-white px-2 py-0.5 rounded-lg">Ø§Ù„Ù…Ø´Ø±Ù: {item.SupervisorName}</span>
                    </div>
                    <p className="italic text-gray-600 leading-relaxed font-semibold">"{item.Comment}"</p>
                  </div>
                  {tab === 'pending' ? (
                    <div className="grid grid-cols-1 gap-2">
                      {FOLLOWUP_RESULTS.map(res => (
                        <button key={res} disabled={updating === item.CustomerPhone} onClick={() => handleUpdate(item.CustomerPhone, res)} className="text-right p-3 bg-white border border-gray-100 rounded-2xl text-[11px] font-black hover:bg-maroon hover:text-white transition-all flex justify-between items-center">
                          <span>{res}</span>
                          <span className="opacity-0 group-hover:opacity-100">âœ“</span>
                        </button>
                      ))}
                    </div>
                  ) : (
                    <div className="flex items-center gap-2 p-3 bg-green-50 text-green-700 rounded-2xl border border-green-100">
                      <span className="text-lg">âœ…</span>
                      <p className="text-xs font-black">{item.followUpInfo?.FollowUpResult}</p>
                    </div>
                  )}
                </div>
              ))
            )}
          </div>
        </div>
      );
    };
    const CoachingScreen = ({ data, onRefresh, showToast }) => {
      const [tab, setTab] = useState('pending');
      const [isAddingNew, setIsAddingNew] = useState(false);
      const [empSearch, setEmpSearch] = useState('');
      const [selectedEmp, setSelectedEmp] = useState(null);
      const [coachingDetails, setCoachingDetails] = useState('');
      const [coachingDate, setCoachingDate] = useState(new Date().toISOString().split('T')[0]);
      const [showDropdown, setShowDropdown] = useState(false);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const dropdownRef = useRef(null);

      const items = useMemo(() => data.reviews.filter(r => tab === 'pending' ? r.CoachingStatus !== 'ØªÙ… Ø¹Ù…Ù„ ÙƒÙˆØªØ´ÙŠÙ†Ø¬' : r.CoachingStatus === 'ØªÙ… Ø¹Ù…Ù„ ÙƒÙˆØªØ´ÙŠÙ†Ø¬'), [data.reviews, tab]);
      const filteredEmps = useMemo(() => empSearch ? data.employees.filter(e => e.EmployeeName.toLowerCase().includes(empSearch.toLowerCase())) : data.employees, [empSearch, data.employees]);

      const handleSaveNew = async (e) => {
        e.preventDefault();
        if (!selectedEmp || !coachingDetails) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        setIsSubmitting(true);
        try {
          await api.postData('addReview', {
            messageDate: coachingDate, customerPhone: 'ÙŠØ¯ÙˆÙŠ', employeeName: selectedEmp.EmployeeName,
            supervisorName: selectedEmp.SupervisorName, comment: coachingDetails, categories: 'ÙƒÙˆØªØ´ÙŠÙ†Ø¬ ÙŠØ¯ÙˆÙŠ',
            reviewerName: 'Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ', coachingStatus: 'ØªÙ… Ø¹Ù…Ù„ ÙƒÙˆØªØ´ÙŠÙ†Ø¬'
          });
          showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
          setIsAddingNew(false); setCoachingDetails(''); setSelectedEmp(null); setEmpSearch(''); onRefresh();
        } catch (e) { alert("Ø®Ø·Ø£"); }
        setIsSubmitting(false);
      };

      const handleComplete = async (rev) => {
        try {
          await api.postData('updateCoaching', { customerPhone: rev.CustomerPhone, employeeName: rev.EmployeeName });
          showToast("ØªÙ… Ø§Ù„Ø¥ØªÙ…Ø§Ù…"); onRefresh();
        } catch (e) { alert("Ø®Ø·Ø£"); }
      };

      return (
        <div className="animate-in space-y-6">
          <ScreenHeader title="Ø§Ù„ÙƒÙˆØªØ´ÙŠÙ†Ø¬" subtitle="ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¢Ø¯Ø§Ø¡" icon="ğŸ‘¨â€ğŸ«" totalLabel="Ù…ÙƒØªÙ…Ù„" totalCount={data.reviews.filter(r => r.CoachingStatus === 'ØªÙ… Ø¹Ù…Ù„ ÙƒÙˆØªØ´ÙŠÙ†Ø¬').length} />
          
          <button onClick={() => setIsAddingNew(!isAddingNew)} className={`w-full py-4 rounded-2xl font-black shadow-lg ${isAddingNew ? 'bg-gray-100 text-gray-500' : 'bg-maroon text-white'}`}>
            {isAddingNew ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©' : 'â• Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØªØ´ÙŠÙ†Ø¬ Ø¬Ø¯ÙŠØ¯'}
          </button>

          {isAddingNew && (
            <form onSubmit={handleSaveNew} className="bg-white p-6 rounded-3xl shadow-sm border space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="relative">
                  <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ù…ÙŠÙ„..." value={selectedEmp ? selectedEmp.EmployeeName : empSearch} onChange={e => {setEmpSearch(e.target.value); setSelectedEmp(null); setShowDropdown(true);}} onFocus={() => setShowDropdown(true)} className="w-full p-3 bg-gray-50 border rounded-xl font-bold outline-none" required />
                  {showDropdown && filteredEmps.length > 0 && (
                    <ul className="absolute z-50 w-full mt-1 bg-white border rounded-xl shadow-2xl max-h-48 overflow-y-auto">
                      {filteredEmps.map((emp, i) => (
                        <li key={i} onClick={() => {setSelectedEmp(emp); setShowDropdown(false);}} className="p-3 hover:bg-maroon hover:text-white cursor-pointer font-bold border-b text-xs">{emp.EmployeeName}</li>
                      ))}
                    </ul>
                  )}
                </div>
                <input type="date" value={coachingDate} onChange={e => setCoachingDate(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-xl font-bold outline-none" required />
              </div>
              <textarea value={coachingDetails} onChange={e => setCoachingDetails(e.target.value)} placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©..." className="w-full p-4 bg-gray-50 border rounded-xl font-bold h-32" required />
              <button type="submit" disabled={isSubmitting} className="w-full bg-green-600 text-white py-4 rounded-xl font-black">{isSubmitting ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØªØ´ÙŠÙ†Ø¬'}</button>
            </form>
          )}

          {!isAddingNew && (
            <>
              <div className="flex bg-white p-1 rounded-2xl shadow-sm border border-gray-100">
                           <button onClick={() => setTab('pending')} className={`flex-1 py-3 font-black text-xs rounded-xl transition-all ${tab === 'pending' ? 'bg-maroon text-white shadow-md' : 'text-gray-400'}`}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ({data.reviews.filter(r => r.CoachingStatus !== 'ØªÙ… Ø¹Ù…Ù„ ÙƒÙˆØªØ´ÙŠÙ†Ø¬').length})</button>
            <button onClick={() => setTab('completed')} className={`flex-1 py-3 font-black text-xs rounded-xl transition-all ${tab === 'completed' ? 'bg-maroon text-white shadow-md' : 'text-gray-400'}`}>Ù…ÙƒØªÙ…Ù„ ({data.reviews.filter(r => r.CoachingStatus === 'ØªÙ… Ø¹Ù…Ù„ ÙƒÙˆØªØ´ÙŠÙ†Ø¬').length})</button>
              </div>
              <div className="space-y-4">
                {items.map((item, i) => (
                  <div key={i} className="bg-white p-5 rounded-2xl shadow-sm border-r-4 border-maroon border border-gray-100 flex justify-between items-start">
                    <div>
                      <p className="font-black text-gray-800">{item.EmployeeName}</p>
                      <p className="text-[10px] text-gray-500 italic mt-1">"{item.Comment}"</p>
                    </div>
                    {tab === 'pending' && <button onClick={() => handleComplete(item)} className="bg-green-600 text-white px-4 py-2 rounded-xl text-[10px] font-black">Ø¥ØªÙ…Ø§Ù… âœ“</button>}
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
      );
    };

    const InquiryScreen = ({ data, onRefresh, showToast }) => {
      const [empSearch, setEmpSearch] = useState('');
      const [selectedEmp, setSelectedEmp] = useState(null);
      const [type, setType] = useState(null);
      const [showDropdown, setShowDropdown] = useState(false);
      const [submitting, setSubmitting] = useState(false);
      const dropRef = useRef(null);

      useEffect(() => {
        const clickAway = (e) => { if (dropRef.current && !dropRef.current.contains(e.target)) setShowDropdown(false); };
        document.addEventListener('mousedown', clickAway);
        return () => document.removeEventListener('mousedown', clickAway);
      }, []);

      const filtered = useMemo(() => {
        if (!empSearch) return data.employees;
        return data.employees.filter(e => e.EmployeeName.toLowerCase().includes(empSearch.toLowerCase()));
      }, [empSearch, data.employees]);

      const handleSave = async () => {
        if (!selectedEmp || !type) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø²Ù…ÙŠÙ„ ÙˆØ§Ù„Ù†ÙˆØ¹");
        setSubmitting(true);
        await api.postData('addInquiry', { employeeName: selectedEmp.EmployeeName, type });
        showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±");
        setEmpSearch(''); setSelectedEmp(null); setType(null);
        onRefresh();
        setSubmitting(false);
      };

      return (
        <div className="animate-screen">
          <ScreenHeader title="Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª" subtitle="ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©" icon="â“" totalLabel="Ø§Ù„ÙƒÙ„" totalCount={data.inquiries.length} />
          <div className="bg-white p-6 rounded-3xl shadow-sm border space-y-8">
            <div className="space-y-1 relative" ref={dropRef}>
              <label className="text-[11px] font-black text-gray-500">Ø§Ø³Ù… Ø§Ù„Ø²Ù…ÙŠÙ„</label>
              <input type="text" placeholder="Ø§Ø¨Ø­Ø«..." value={selectedEmp ? selectedEmp.EmployeeName : empSearch} onChange={e => { setEmpSearch(e.target.value); setSelectedEmp(null); setShowDropdown(true); }} onFocus={() => setShowDropdown(true)} className="w-full p-3 bg-gray-50 border rounded-xl font-bold outline-none" />
              {showDropdown && filtered.length > 0 && (
                <ul className="absolute z-50 w-full mt-1 bg-white border rounded-xl shadow-xl max-h-48 overflow-y-auto">
                  {filtered.map((e, i) => <li key={i} onClick={() => { setSelectedEmp(e); setShowDropdown(false); }} className="p-3 hover:bg-maroon hover:text-white cursor-pointer font-bold border-b text-xs">{e.EmployeeName}</li>)}
                </ul>
              )}
            </div>
            <div className="space-y-2">
              <label className="text-[11px] font-black text-gray-500">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±</label>
              <div className="grid grid-cols-1 gap-1.5">
                {INQUIRY_TYPES.map(t => (
                  <button key={t} onClick={() => setType(t)} className={`w-full p-3 rounded-xl border text-[11px] font-black transition-all flex justify-between items-center ${type === t ? 'bg-maroon text-white border-maroon' : 'bg-white text-gray-500 border-gray-100'}`}>
                    <span>{t}</span> {type === t && 'âœ“'}
                  </button>
                ))}
              </div>
            </div>
            <button onClick={handleSave} disabled={submitting} className="w-full bg-maroon text-white py-4 rounded-xl font-black text-lg shadow-lg disabled:opacity-50">ØªØ£ÙƒÙŠØ¯</button>
          </div>
        </div>
      );
    };

    const AnalyticsScreen = ({ data }) => {
      const [filter, setFilter] = useState('all');

      const filtered = useMemo(() => {
        const now = new Date();
        const checkDate = (date) => {
          if (!date) return false;
          const d = new Date(date);
          if (filter === 'today') return d.toDateString() === now.toDateString();
          if (filter === 'week') { const w = new Date(); w.setDate(now.getDate() - 7); return d >= w; }
          if (filter === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
          return true;
        };
        const revs = data.reviews.filter(r => checkDate(r.ReviewDate || r.MessageDate));
        return {
          reviews: revs,
          followups: data.followups.filter(f => checkDate(f.FollowUpDate)),
          inquiries: data.inquiries.filter(i => checkDate(i.InquiryDate)),
          coaching: revs.filter(r => r.CoachingStatus === 'ØªÙ… Ø¹Ù…Ù„ ÙƒÙˆØªØ´ÙŠÙ†Ø¬').length
        };
      }, [data, filter]);

      // Categories and Leaders per Category
      const leaders = useMemo(() => {
        return CATEGORIES.map(cat => {
          const counts = {};
          filtered.reviews.forEach(r => { 
            if (r.Category.includes(cat)) counts[r.EmployeeName] = (counts[r.EmployeeName] || 0) + 1; 
          });
          const top = Object.entries(counts).sort((a, b) => b[1] - a[1])[0];
          return { name: cat, top: top ? top[0] : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯', count: top ? top[1] : 0 };
        });
      }, [filtered.reviews]);

      // Category overall stats
      const catStats = useMemo(() => {
        const total = filtered.reviews.length || 1;
        return CATEGORIES.map(cat => {
          const count = filtered.reviews.filter(r => r.Category.includes(cat)).length;
          return { name: cat, count, pct: ((count / total) * 100).toFixed(1) };
        });
      }, [filtered.reviews]);

      // Top 3 Employees (The "Repeat Offenders")
      const topEmployees = useMemo(() => {
        const counts = {};
        filtered.reviews.forEach(r => {
          if (!counts[r.EmployeeName]) counts[r.EmployeeName] = { count: 0, supervisor: r.SupervisorName, reviews: [] };
          counts[r.EmployeeName].count++;
          counts[r.EmployeeName].reviews.push(r);
        });
        return Object.entries(counts).sort((a, b) => b[1].count - a[1].count).slice(0, 3);
      }, [filtered.reviews]);

      // Inquiry types stats
      const inquiryAnalysis = useMemo(() => {
        const total = filtered.inquiries.length || 1;
        return INQUIRY_TYPES.map(t => {
          const count = filtered.inquiries.filter(i => i.InquiryType === t).length;
          return { name: t, count, pct: ((count / total) * 100).toFixed(1) };
        });
      }, [filtered.inquiries]);

      // Follow-up outcomes stats
      const followUpOutcomes = useMemo(() => {
        const total = filtered.followups.length || 1;
        return FOLLOWUP_RESULTS.map(r => {
          const count = filtered.followups.filter(f => f.FollowUpResult === r).length;
          return { name: r, count, pct: ((count / total) * 100).toFixed(1) };
        });
      }, [filtered.followups]);

      // Reviewer Productivity
      const reviewerStats = useMemo(() => {
        const total = filtered.reviews.length || 1;
        return REVIEWERS.map(name => {
          const count = filtered.reviews.filter(r => r.ReviewerName === name).length;
          return { name, count, pct: ((count / total) * 100).toFixed(0) };
        });
      }, [filtered.reviews]);

      // Supervisor detailed breakdown
      const supervisors = useMemo(() => {
        const counts = {};
        filtered.reviews.forEach(r => {
          if (!counts[r.SupervisorName]) counts[r.SupervisorName] = { count: 0, team: {} };
          counts[r.SupervisorName].count++;
          if (!counts[r.SupervisorName].team[r.EmployeeName]) counts[r.SupervisorName].team[r.EmployeeName] = { count: 0, reviews: [] };
          counts[r.SupervisorName].team[r.EmployeeName].count++;
          counts[r.SupervisorName].team[r.EmployeeName].reviews.push(r);
        });
        return Object.entries(counts).sort((a, b) => b[1].count - a[1].count);
      }, [filtered.reviews]);

      return (
        <div className="animate-screen space-y-10 pb-20">
          <ScreenHeader title="Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª" subtitle="Ø±Ø¤ÙŠØ© Ø´Ø§Ù…Ù„Ø© Ù„Ø¢Ø¯Ø§Ø¡ Ø§Ù„Ø²Ù…Ù„Ø§Ø¡" icon="ğŸ“Š" totalLabel="Ø§Ù„ÙÙ„ØªØ±" totalCount={filter === 'all' ? 'Ø§Ù„ÙƒÙ„' : filter} />
          
          <div className="flex bg-maroon-dark p-1.5 rounded-2xl gap-1 mb-8 max-w-sm mx-auto shadow-xl">
            {['today', 'week', 'month', 'all'].map(f => (
              <button key={f} onClick={() => setFilter(f)} className={`flex-1 py-2 text-[10px] font-black rounded-xl transition-all ${filter === f ? 'bg-white text-maroon shadow-md' : 'text-white/40'}`}>
                {f === 'today' ? 'Ø§Ù„ÙŠÙˆÙ…' : f === 'week' ? 'Ø£Ø³Ø¨ÙˆØ¹' : f === 'month' ? 'Ø´Ù‡Ø±' : 'Ø§Ù„ÙƒÙ„'}
              </button>
            ))}
          </div>

          <div className="grid grid-cols-4 gap-2">
            {[
              { label: 'Ù…Ø±Ø§Ø¬Ø¹Ø§Øª', val: filtered.reviews.length, icon: 'ğŸ“', c: 'text-maroon' },
              { label: 'Ù…ØªØ§Ø¨Ø¹Ø§Øª', val: filtered.followups.length, icon: 'ğŸ“', c: 'text-blue-600' },
              { label: 'ÙƒÙˆØªØ´ÙŠÙ†Ø¬', val: filtered.coaching, icon: 'ğŸ‘¨â€ğŸ«', c: 'text-green-600' },
              { label: 'Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª', val: filtered.inquiries.length, icon: 'â“', c: 'text-orange-600' }
            ].map((s, i) => (
              <div key={i} className="bg-white p-3 rounded-2xl shadow-sm text-center border">
                <p className="text-[8px] text-gray-400 font-black mb-1">{s.label}</p>
                <p className={`text-lg font-black ${s.c}`}>{s.val}</p>
              </div>
            ))}
          </div>

          <div className="space-y-8">
            {/* Top 3 Employees Section */}
            <section className="bg-gradient-to-br from-maroon to-maroon-dark p-6 rounded-3xl text-white shadow-xl">
              <h3 className="font-black text-sm mb-6 flex items-center gap-2">ğŸš© Ø§Ù„Ø²Ù…Ù„Ø§Ø¡ Ø§Ù„Ø£ÙƒØ«Ø± ØªÙƒØ±Ø§Ø±Ø§Ù‹ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ (Top 3)</h3>
              <div className="space-y-4">
                {topEmployees.map(([name, stats]) => (
                  <div key={name} className="bg-white/10 p-4 rounded-2xl border border-white/10 group">
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <p className="font-black text-md">{name}</p>
                        <p className="text-[9px] opacity-60">Ø§Ù„Ù…Ø´Ø±Ù: {stats.supervisor}</p>
                      </div>
                      <span className="bg-white text-maroon px-2 py-1 rounded-lg font-black text-[10px]">{stats.count} Ø±Ø³Ø§Ù„Ø©</span>
                    </div>
                    <details className="mt-3">
                      <summary className="text-[9px] font-black text-white/40 cursor-pointer list-none flex items-center gap-1">Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø§ØªÙ‡ <span className="text-[7px]">â–¼</span></summary>
                      <div className="mt-2 space-y-2 border-t border-white/10 pt-2">
                        {stats.reviews.map((r, ri) => (
                          <div key={ri} className="text-[9px] opacity-80 bg-black/10 p-2 rounded-lg italic">
                             - {r.Category}: "{r.Comment}" ({r.CustomerPhone})
                          </div>
                        ))}
                      </div>
                    </details>
                  </div>
                ))}
              </div>
            </section>

            {/* Error Leaders by Category */}
            <section className="bg-gradient-to-br from-maroon to-maroon-dark p-8 rounded-4xl text-white shadow-xl">
              <h3 className="font-black text-xl mb-6 flex items-center gap-3">ğŸ¥‡ Ø£ÙƒØªØ± Ø²Ù…ÙŠÙ„ Ù…Ø®Ø·Ø¦ Ø­Ø³Ø¨ ÙƒÙ„ ØªØµÙ†ÙŠÙ</h3>
              <div className="space-y-3">
                {leaders.map(l => (
                  <div key={l.name} className="glass p-4 rounded-2xl flex justify-between items-center bg-white/10 border-white/10">
                    <div className="text-right">
                      <p className="text-[9px] text-white/50 font-black uppercase tracking-widest">{l.name}</p>
                      <p className="text-sm font-black">{l.top}</p>
                    </div>
                    <span className="bg-white text-maroon px-3 py-1 rounded-full font-black text-xs">{l.count} Ø±Ø³Ø§Ù„Ø©</span>
                  </div>
                ))}
              </div>
            </section>

            {/* Category Results Progress Bars */}
            <section className="bg-white p-8 rounded-4xl shadow-sm border">
              <h3 className="font-black text-xl mb-6 text-gray-800 flex items-center gap-3">ğŸ“ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª</h3>
              <div className="space-y-6">
                {catStats.map(cat => (
                  <div key={cat.name} className="relative group">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-xs font-black text-gray-700">{cat.name}</span>
                      <span className="text-[10px] font-black text-maroon">{cat.count} ({cat.pct}%)</span>
                    </div>
                    <div className="overflow-hidden h-2.5 rounded-full bg-red-50">
                      <div style={{ width: `${cat.pct}%` }} className="h-full bg-maroon transition-all duration-1000"></div>
                    </div>
                  </div>
                ))}
              </div>
            </section>

            {/* Inquiry Analysis Bars */}
            <section className="bg-white p-8 rounded-4xl shadow-sm border">
              <h3 className="font-black text-xl mb-6 text-gray-800">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª</h3>
              <div className="space-y-4">
                {inquiryAnalysis.map(i => (
                  <div key={i.name} className="relative">
                    <div className="flex justify-between mb-1 text-[11px] font-black text-gray-600">
                      <span>{i.name}</span> <span>{i.count} ({i.pct}%)</span>
                    </div>
                    <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                      <div style={{ width: `${i.pct}%` }} className="h-full bg-orange-400"></div>
                    </div>
                  </div>
                ))}
              </div>
            </section>

            {/* Follow-up Results Analysis */}
            <section className="bg-white p-8 rounded-4xl shadow-sm border">
              <h3 className="font-black text-xl mb-6 text-gray-800">ğŸ“ˆ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª</h3>
              <div className="space-y-4">
                {followUpOutcomes.map(o => (
                  <div key={o.name} className="relative">
                    <div className="flex justify-between mb-1 text-[11px] font-black text-gray-600">
                      <span>{o.name}</span> <span>{o.count} ({o.pct}%)</span>
                    </div>
                    <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                      <div style={{ width: `${o.pct}%` }} className="h-full bg-blue-500"></div>
                    </div>
                  </div>
                ))}
              </div>
            </section>

            {/* Reviewer Productivity Cards */}
            <section className="bg-white p-8 rounded-4xl shadow-sm border text-center">
              <h3 className="font-black text-xl mb-8">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</h3>
              <div className="grid grid-cols-2 gap-6">
                {reviewerStats.map(rev => (
                  <div key={rev.name} className="p-8 bg-maroon text-white rounded-3xl shadow-xl transform hover:-translate-y-1 transition-all">
                    <p className="text-[10px] font-black opacity-60 uppercase mb-2">{rev.name}</p>
                    <p className="text-4xl font-black mb-2">{rev.count}</p>
                    <p className="text-[10px] font-bold opacity-40">%{rev.pct}</p>
                  </div>
                ))}
              </div>
            </section>

            {/* Supervisor Team Breakdown Section */}
            <section className="bg-white p-8 rounded-4xl shadow-sm border">
              <h3 className="font-black text-xl mb-6 text-gray-800 flex items-center gap-3">ğŸ‘¥ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø­Ø³Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø²Ù…Ù„Ø§Ø¡</h3>
              <div className="space-y-6">
                {supervisors.slice(0, 5).map(([name, stats]) => (
                  <div key={name} className="p-6 rounded-3xl border border-red-100 bg-red-50/20 group transition-all">
                    <div className="flex justify-between items-center mb-4">
                      <div>
                        <p className="font-black text-maroon text-lg">{name}</p>
                        <p className="text-[10px] text-gray-400 font-bold tracking-widest uppercase">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: {stats.count}</p>
                      </div>
                      <div className="w-12 h-12 rounded-full bg-maroon/10 flex items-center justify-center text-maroon font-black">
                        {Object.keys(stats.team).length}
                      </div>
                    </div>
                    <div className="space-y-4 border-t border-maroon/5 pt-4">
                      {Object.entries(stats.team).map(([empName, empStats]) => (
                        <details key={empName} className="group/detail">
                          <summary className="list-none cursor-pointer flex justify-between items-center p-3 bg-white rounded-xl border border-gray-100 hover:border-maroon/20 transition-all">
                            <span className="font-bold text-gray-700 text-sm">{empName}</span>
                            <span className="bg-maroon/10 text-maroon px-2 py-0.5 rounded-lg text-[10px] font-black">{empStats.count} Ø±Ø³Ø§Ù„Ø©</span>
                          </summary>
                          <div className="mt-2 p-3 bg-gray-50 rounded-xl space-y-3 max-h-48 overflow-y-auto custom-scrollbar">
                            {empStats.reviews.map((r, ri) => (
                              <div key={ri} className="text-[10px] border-b last:border-0 border-gray-200 pb-2 mb-2">
                                <div className="flex justify-between text-maroon font-black mb-1">
                                  <span>{new Date(r.MessageDate).toLocaleDateString('ar-EG')}</span>
                                  <span>{r.CustomerPhone}</span>
                                </div>
                                <p className="text-gray-600 italic">"{r.Comment}"</p>
                              </div>
                            ))}
                          </div>
                        </details>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </section>
          </div>
        </div>
      );
    };

    // --- Main ---

    const App = () => {
      const [activeTab, setActiveTab] = useState('reviews');
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [isAuthorized, setIsAuthorized] = useState(false);
      const [pin, setPin] = useState('');
      const [showPin, setShowPin] = useState(false);
      const [targetTab, setTargetTab] = useState(null);
      const [toastMsg, setToastMsg] = useState(null);

      const showToast = (msg) => { setToastMsg(msg); setTimeout(() => setToastMsg(null), 3000); };
      const refresh = useCallback(async () => { 
        setLoading(true); 
        try { 
          const d = await api.fetchData(); 
          setData(d); 
        } catch (e) {
          console.error("Fetch error", e);
        } 
        setLoading(false); 
      }, []);

      useEffect(() => { refresh(); }, [refresh]);
      useEffect(() => { window.scrollTo({ top: 0, behavior: 'smooth' }); }, [activeTab]);

      const handleNav = (tab) => {
        if (tab === 'reviews' || isAuthorized) setActiveTab(tab);
        else { setTargetTab(tab); setShowPin(true); }
      };

      const handleAuth = (e) => {
        e.preventDefault();
        if (pin === '0777') { 
          setIsAuthorized(true); 
          if (targetTab) setActiveTab(targetTab); 
          setShowPin(false); 
          showToast("ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­"); 
        }
        else { 
          alert("Ø±Ù…Ø² Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­"); 
          setPin(''); 
        }
      };

      if (loading && !data) return <div className="min-h-screen flex items-center justify-center bg-white"><div className="w-12 h-12 border-4 border-maroon border-t-transparent rounded-full animate-spin"></div></div>;

      return (
        <div className="min-h-screen pb-32">
          <Toast message={toastMsg} />
          <header className="bg-maroon-dark text-white py-4 text-center sticky top-0 z-40 shadow-xl border-b border-white/10">
            <h1 className="text-xl font-black flex justify-center items-center gap-2 animate-pulse">âœ¦ Evaluation âœ¦</h1>
          </header>

          <main className="container mx-auto px-4 py-6 max-w-xl">
            {activeTab === 'reviews' && <ReviewScreen data={data} onRefresh={refresh} showToast={showToast} />}
            {activeTab === 'followups' && <FollowUpScreen data={data} onRefresh={refresh} showToast={showToast} />}
            {activeTab === 'coaching' && <CoachingScreen data={data} onRefresh={refresh} showToast={showToast} />}
            {activeTab === 'inquiries' && <InquiryScreen data={data} onRefresh={refresh} showToast={showToast} />}
            {activeTab === 'analytics' && <AnalyticsScreen data={data} />}
          </main>

          <nav className="fixed bottom-0 left-0 right-0 h-20 bg-maroon text-white flex justify-around items-center px-4 rounded-t-3xl z-50 shadow-2xl">
            {[
              { id: 'reviews', icon: 'ğŸ“', lbl: 'Ù…Ø±Ø§Ø¬Ø¹Ø©' },
              { id: 'followups', icon: 'ğŸ“', lbl: 'Ù…ØªØ§Ø¨Ø¹Ø©' },
              { id: 'coaching', icon: 'ğŸ‘¨â€ğŸ«', lbl: 'ÙƒÙˆØªØ´Ù†Ø¬' },
              { id: 'inquiries', icon: 'â“', lbl: 'Ø§Ø³ØªÙØ³Ø§Ø±' },
              { id: 'analytics', icon: 'ğŸ“Š', lbl: 'ØªØ­Ù„ÙŠÙ„' }
            ].map(t => (
              <button key={t.id} onClick={() => handleNav(t.id)} className={`flex flex-col items-center justify-center flex-1 transition-all h-full gap-1 relative ${activeTab === t.id ? 'scale-105 opacity-100' : 'opacity-40 hover:opacity-70'}`}>
                {activeTab === t.id && <div className="absolute inset-x-2 inset-y-3 bg-white/10 rounded-2xl blur-sm"></div>}
                <span className="text-xl z-10">{t.icon}</span>
                <span className="text-[9px] font-black z-10">{t.lbl}</span>
              </button>
            ))}
          </nav>

          {showPin && (
            <div className="fixed inset-0 bg-maroon-dark/60 backdrop-blur-md z-[150] flex items-center justify-center p-6">
              <div className="bg-white rounded-3xl p-8 w-full max-w-xs shadow-2xl text-center">
                <h2 className="text-xl font-black text-maroon mb-2">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</h2>
                <p className="text-[10px] text-gray-400 mb-6 font-bold">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
                <form onSubmit={handleAuth} className="space-y-4">
                  <input autoFocus type="password" value={pin} onChange={e => setPin(e.target.value)} placeholder="â€¢â€¢â€¢â€¢" className="w-full text-center text-3xl py-3 bg-gray-50 border rounded-2xl focus:border-maroon outline-none font-black" maxLength={4} />
                  <div className="flex gap-2">
                    <button type="button" onClick={() => setShowPin(false)} className="flex-1 py-3 font-black bg-gray-100 rounded-xl text-gray-500 text-xs">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" className="flex-1 py-3 font-black bg-maroon text-white rounded-xl shadow-lg text-xs">Ø¯Ø®ÙˆÙ„</button>
                  </div>
                </form>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>